<?php 

class MyModuleTestCase extends DrupalWebTestCase {
  
  public static function getInfo() {
    return array(
      'name' => 'ECK',
      'description' => 'Test Entity Administration',
      'group' => 'ECK',
    );
  }

  public function setUp() {
    parent::setUp('entity', 'eck');
  }

  public function testECK() {  

    $name = "test";
    $label = "Test";
    
    $user = $this->drupalCreateUser(array('administer entity'));
    $this->drupalLogin($user);

    //ADD an Entity
    $edit = array();
    $edit['name'] = $name;
    $edit['label'] = $label;
    
    $this->drupalPost('admin/eck/add', $edit, t('Save'));
  
    $this->assertTrue($this->eckCount('eck', array('name' => $name, 'label' => $label)), 
      'A record of the "Test" entity is in the eck table');
    
    $this->assertTrue(db_table_exists('eck_test'), "The database table for the entity was created");
    
   /* $this->drupalLogout();
    
    cache_clear_all();
    menu_rebuild();
    cache_clear_all();*/
    
    /************ "Test" ENTITY CRUD ***************/
   /* //Create an user with the permission to add "Test" entity instances
    $user = $this->drupalCreateUser(array('administer entity', 'add test'));
    $this->drupalLogin($user);
    
    //Add a new "Test" Entity
    $this->drupalGet('admin/eck/test/add');
    //$this->assertTrue($this->eckCount('eck_test'), 
      //'An instance of the "Test" entity is in the eck_test table');
    
    //Delete the "Test" Entity
    $this->drupalPost('admin/eck/test/1/delete', array(), t('Delete'));
     $this->assertFalse($this->eckCount('eck_test'), 
      'The instance of the "Test" entity has been deleted from the eck_test table');*/
    
    //DELETE an Entity
    $this->drupalPost('admin/eck/test/delete', array(), t('Delete'));
    
    $this->assertFalse($this->eckCount('eck', array('name' => $name, 'label' => $label)), 
      'A record of the "Test" entity has been deleted from the eck table');
    
    $this->assertFalse(db_table_exists('eck_test'), "The database table for the entity has been deleted");
  }
  
  //count the number of rows in the eck table with the given name and label
  protected function eckCount($table, $conditions = array()){

    $query = db_select($table, 'e')->fields('e');
    
    foreach($conditions as $property => $value){
        $query->condition($property, $value, '=');
    }
    
    $results = $query->execute();
    
    $count = 0;
    
    foreach($results as $record){
      $count++;
    }
    
    return $count;
  }
}