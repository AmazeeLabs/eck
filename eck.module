<?php 
// $Id$

/**
 * @file
 * 
 * Here is all of the logic that creates and manages entities
 * 
 * TODO: Write some more about the logic flow of things
 */

/****************************************************
 *             ENTITY CONSTRUCTION KIT
 ****************************************************/

/**
 * The Entity information for all the entities created
 * with the factory
 */
function eck_entity_info() {
  dpm("Entity Info");
  $info = array();
  
  //Get all the data from the eck table (All of the entities created)
  $results = _db_get_all('eck');
  
  //for each of the created entities add its entity info to the $info array
  foreach ($results as $entity) {
 
    //eck__entity_info creates the entity_info for each entity
    $info = array_merge($info, eck__entity__info($entity));
  }
  
  return $info;
}

/**
 * Define the paths for the administration section of the Entity Factory
 */
function eck_menu() {
  
  $menu =  eck__entity__menu();
  
  /* //DELETE Entity
  $items["admin/eck/{$name}/delete"] = array(
    'title' => 'Add',
    'description' => "Add {$name}",
    'page callback' => "drupal_get_form",
    'page arguments' => array('eck_delete', $name, $label),
    'access arguments' => array("administer entity"),
   'type' => MENU_CALLBACK,
  );*/
    
  
 
  
 /* //READ Entity Instance
  $items["{$name}/%"] = array(
    'title' => "{$name}",
    'description' => "View the object of {$name} type",
    'page callback' => "eck__entity_page",
    'page arguments' => array($name, 1),
    'access arguments' => array("view {$name}"),
    'weight' => 0
  );
  
  $items["{$name}/%/view"] = array(
    'title' => "View",
    'type' => MENU_DEFAULT_LOCAL_TASK
  );
  
  //UPDATE Entity Instance
  $items["{$name}/%/edit"] = array(
    'title' => "Edit",
    'description' => "Edit the object of {$name} type",
    'page callback' => "eck__entity_edit",
    'page arguments' => array($name, 1),
    'access arguments' => array("edit {$name}"),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1
  );
  
  //DELETE Entity Instance
  $items["admin/eck/{$name}/%/delete"] = array(
    'title' => "Delete {$name}",
    'description' => "Delete the object of {$name} type",
    'page callback' => "drupal_get_form",
    'page arguments' => array('eck__entity_delete', $name, $label, 3),
    'access arguments' => array("administer entity")
  );*/
  
  return $menu;
  
}

function eck_permission() {
  $perms = 
  array(
    'administer entity' => 
    array(
      'title' => t('Administer Entity'),
      'restrict access' => TRUE
    )
  );
  
  foreach (_db_get_all('eck') as $result) {
    foreach (array('add', 'view', 'edit') as $op) {
      $perms["{$op} {$result->name}"] = 
      array(
        'title' => t(ucfirst($op) . " {$result->label}")
      );
    }
  }
  
  return $perms;
}

/****************************************************
 *           ECK Entity
 ****************************************************/

function eck__entity__menu(){
  $menu = array();
  
  //OVERVIEW Entity
  $menu['admin/eck'] =
  array(
    'title' => 'Entity',
    'description' => 'A centralized Administrative section for Entities',
    'page callback' => 'eck__entity__overview',
    'access arguments' => array('administer entities')
  );
  
  //ADD Entity
  $menu["admin/eck/add"] = array(
    'title' => 'Add Entity',
    'description' => "Add a new Entity",
    'page callback' => "drupal_get_form",
    'page arguments' => array('eck__entity__add'),
    'access arguments' => array("administer entity"),
    'type' => MENU_LOCAL_ACTION,
    'weight' => 1
  );
  
  /******** GET ENTITY TYPE MENUS **********/
  //Now lets get the menus for each of our entity types
  $results = _db_get_all('eck');
  
  foreach ($results as $entity) {
    $menu = array_merge($menu, eck__entity_type__menu($entity));
  }
  
  return $menu;
  
}

function eck__entity__overview() {
  
  $header = array(t('Name'), array('data' => t('Operations'), 'colspan' => '1'));
  $rows = array();
  
  $results = db_select('eck', 'e')->fields('e')->execute();
  
  foreach ($results as $record) {
    $id = $record->id;
    $name = $record->name;
    $label = $record->label;
    
    $row = array(l("{$id} : {$label}", "admin/eck/{$name}"));
    /*$row[] = array('data' => l(t('delete'), "admin/eck/{$name}/delete"));*/
    $rows[] = $row;
  }
  $build['entity_table'] = array(
  '#theme' => 'table',
  '#header' => $header,
  '#rows' => $rows,
  );
  
  return $build;

}

function eck__entity__add($form, &$form_state) {
  
  $form['label'] = array(
    '#type' => 'textfield',
    '#title' => "Name",
    '#description' => "A human readable name for the entity",
    '#required' => TRUE
  );
  
  $form['name'] = array(
  '#type' => 'machine_name',
  '#title' => t('machine name'),
  '#machine_name' => array(
    'exists' => '_eck_fake_exists',
    'source' => array('label'),
    'label' => t('machine name'),
  ));
  
  $form['type_label'] = array(
    '#type' => 'textfield',
    '#title' => "Type (optional)",
    '#description' => "A type with the same name as the entity is created by default, this will override the default",
  );
  
  $form['type'] = array(
    '#type' => 'machine_name',
    '#title' => t('machine name'),
    '#required' => FALSE,
    '#machine_name' => array(
      'exists' => '_eck_fake_exists',
      'source' => array('type_label'),
      'label' => t('machine name'),
  ));
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#weight' => 10000,
    '#value' => t('Save'),
  );
  
  return $form; 
}

/*function eck__entity__add_validate($form, &$form_state) {  
  preg_match("/([^a-z0-9_]|\s)/", $form_state['values']['name'], $matches);
  
  if (!empty($matches)) {
    form_set_error('name', t("Your Entity name has invalid characters or spaces"));
  }
}*/

function eck__entity__add_submit($form, &$form_state) {
  
  //This are required so I don't have to do any checks
  $entity = $form_state['values']['name'];
  $label = $form_state['values']['label'];
  
  //If the table does not exist, then this is a valid entity name, and we can save it.
  if (!db_table_exists("eck_{$entity}")) {
    
    //lets add the type to the table
    if(!empty($form_state['values']['type'])){
      $type = $form_state['values']['type'];
      if(!empty($form_state['values']['type_label'])){
        $type_label = $form_state['values']['type_label'];
      }else{
        $type_label = ucfirst($type);
      }
    }else{
      $type = $entity;
      $type_label = $label;
    }
    
    db_insert('eck_types')
    ->fields(array(
      'entity' => $entity,
      'type' => $type,
      'label' => $type_label,
    ))
    ->execute();
    
    db_insert('eck')
    ->fields(array(
      'name' => $entity,
      'label' => $label,
    ))
    ->execute();
  
    db_create_table("eck_{$entity}", eck__entity__schema($entity));
    
     //lets rebuild the menu for the new entity
     menu_rebuild();
     
     drupal_set_message(t("Entity '{$label}' has been created"));
  }
  else {
    drupal_set_message(t("Database table %name already exists", array('%name' => $entity)), 'error');
  }
}

/*function eck_delete($form, &$form_state, $name, $label) {
  
  $form['entity_name'] =
  array(
  '#type' => 'value',
  '#value' => $name,
  );
  
  $message = t("Are you sure that you want to delete %label", array("%label" => $label));
  $caption = t("This action is irreversible");
  
  return confirm_form($form, $message, 'admin/eck', $caption, t('Delete')); 
}

function eck_delete_submit($form, &$form_state) {
  
  $name = $form_state['values']['entity_name'];
  
  //delete the bundle
  field_attach_delete_bundle($name, $name);
  
  //delete the eck database entry
  db_delete('eck')
  ->condition('name', $name)
  ->execute();
  
  //drop the table
  db_drop_table("eck_{$name}");
  
  drupal_cron_run();
  
  //lets rebuild the menu to remove all entity paths
  menu_rebuild();
  
  $form_state['redirect'] = "admin/eck";
}*/

function eck__entity__schema($name) {
  
   return array(
    'description' => "The base table for a(n) {$name}.",
    'fields' => array(
      'id' => array(
        'description' => "The primary identifier for a(n) {$name}.",
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'type' => array(
        'description' => 'The type of the entity',
        'type' => 'varchar',
        'default' => '',
        'length' => 255,
        'not null' => TRUE,
      ),
      'uid' => array(
        'description' => "The {users}.uid that owns this {$name}; initially, this is the user that created it.",
        'type' => 'int',
        'not null' => TRUE,
        'default' => 0,
      ),
      'created' => array(
        'description' => "The Unix timestamp when the {$name} was created.",
        'type' => 'int',
        'not null' => TRUE,
        'default' => 0,
      ),
      'changed' => array(
        'description' => "The Unix timestamp when the {$name} was most recently saved.",
        'type' => 'int',
        'not null' => TRUE,
        'default' => 0,
      ),
    ),
    'indexes' => array(
      "{$name}_changed" => array('changed'),
      "{$name}_created" => array('created'),
      'uid' => array('uid'),
    ),
    'foreign keys' => 
    array(
      "{$name}_author" => 
       array(
        'table' => 'users',
        'columns' => array('uid' => 'uid'),
      ),
    ),
    'primary key' => array('id'),
  );
}


/**
 * Generate the entity info for a specific entity
 * 
 * @param $name the name of the entity
 * @param $label the label of the entity
 */
function eck__entity__info($entity) {
  $name = $entity->name;
  $label = $entity->label;
  
  $info = array();
  
  $info[$name] = 
  array(
    'label' => t($label),
    'base table' => "eck_{$name}",
    'entity class' => 'Entity',
    'controller class' => 'EntityAPIController',
    'module' => 'eck',
    'fieldable' => TRUE,
    'entity keys' => 
    array(
        'id' => 'id',
        'bundle' => 'type'
    ),
    'label callback' => 'eck__entity_instance__label',
    'uri callback' => 'eck__entity_instance__uri',
    'bundle keys' => 
    array(
      'bundle' => 'type'
    ),
    'view modes' => array(
        'full' => array(
          'label' => t('Full content'), 
          'custom settings' => TRUE,
        ), 
        'teaser' => array(
          'label' => t('Teaser'), 
          'custom settings' => TRUE,
        ), 
        'search' => array(
          'label' => t('Search'), 
          'custom settings' => TRUE,
        ), 
        'xml' => array(
          'label' => t('XML'), 
          'custom settings' => TRUE,
        ), 
        'rss' => array(
          'label' => t('RSS'), 
          'custom settings' => TRUE,
        ),
      )
  );
  
  $types = _get_types($name);
  
  
  
  foreach($types as $type){
    
    //dpm($type, $name);
    
    //dpm("admin/eck/{$name}/{$type->type}", "Info Path");
  
    $info[$name]['bundles'][$type->type] = array(
      'label' => $type->label,
      'admin' => array(
        'path' => "admin/eck/{$name}/{$type->type}",
        'access arguments' => array("administer entity")
       )
     );
  }
  
  return $info;
}

/****************************************************
 *                    ENTITY Type
 ****************************************************/
function eck__entity_type__overview($entity){
  
  $entity_name = $entity->name;
  
  $header = array(t('Type'), array('data' => t('Operations'), 'colspan' => '1'));
  $rows = array();
  
  foreach (_get_types($entity_name) as $type) {
      $id = $type->id;
      $uri = "admin/eck/$entity_name/{$type->type}";
      $row = array(l($type->label, url($uri, array('absolute' => TRUE))));
      //$row[] = array('data' => l(t('delete'), "admin/eck/{$name}/{$id}/delete"));
      $rows[] = $row;
  }
  
  $build['entity_types_table'] = array(
  '#theme' => 'table',
  '#header' => $header,
  '#rows' => $rows,
  );
  
  return $build;
  
}

function eck__entity_type__menu($entity){
  $entity_name = $entity->name;
  $entity_label = $entity->label;
  
  //Create the menus relavant to types
  $menu = array();
  
  //OVERVIEW Entity types
  $menu["admin/eck/{$entity_name}"] = array(
    'title' => $entity_label,
    'description' => "View all types of the '{$entity_label}' entity",
    'page callback' => "eck__entity_type__overview",
    'page arguments' => array($entity),
    'access arguments' => array("administer {$entity_label} types"),
    'weight' => 0
  );
  
  $menu["admin/eck/{$entity_name}/add"] = array(
    'title' => "Add '{$entity_label}' Type",
    'description' => "Add a new '{$entity_label}' type",
    'page callback' => "drupal_get_form",
    'page arguments' => array('eck__entity_type__add', $entity),
    'access arguments' => array("add {$entity_label} type"),
    'type' => MENU_LOCAL_ACTION,
    'weight' => 1
  );
  
  foreach(_get_types($entity_name) as $type){
    $menu = array_merge($menu, eck__entity_instance__menu($entity, $type));
  }
  
  
  return $menu;
}

//ADD Entity types
function eck__entity_type__add($form, &$form_state, $entity){
  
  $form['entity'] = array(
    '#type' => 'value',
    '#value' => $entity,
  );
  
  $form['type_label'] = array(
    '#type' => 'textfield',
    '#title' => "Type",
    '#description' => "A Human readable name for the type",
  );
  
  $form['type'] = array(
    '#type' => 'machine_name',
    '#title' => t('machine name'),
    '#required' => FALSE,
    '#machine_name' => array(
      'exists' => '_eck_fake_exists',
      'source' => array('type_label'),
      'label' => t('machine name'),
  ));
  
  $form['#validate'][] = 'eck__entity_type__add_validate';
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#weight' => 10000,
    '#value' => t('Save'),
  );
  
  return $form; 
}

function eck__entity_type__add_validate($form, &$form_state){
  
  $entity = $form_state['values']['entity'];
  
  //the type does not have to be unique in the table, but it should be unique to its entity so we will check that here
  $types = _get_types($entity->name);
  
  foreach($types as $type){
    if($type->type == $form_state['values']['type']){
      form_set_error('type', t("type '{$type->type} already exists in this entity"));
    }
  }
} 


function eck__entity_type__add_submit($form, &$form_state){
  
  $entity = $form_state['values']['entity'];
  $type = $form_state['values']['type'];
  $type_label = $form_state['values']['type_label'];
  
  db_insert('eck_types')
    ->fields(array(
      'entity' => $entity->name,
      'type' => $type,
      'label' => $type_label,
    ))
    ->execute();
    
    drupal_set_message(t("'{$entity->label}' type '{$type_label}' has been saved"));
    menu_rebuild();
}


/****************************************************
 *                    ENTITY Instances
 ****************************************************/

function eck__entity_instance__menu($entity, $type){
  $menu = array();
  
  $entity_name = $entity->name;
  $entity_label = $entity->label;
  $entity_type = $type->type;
  $entity_type_label = $type->label;
  
  
  //OVERVIEW Entity Instance
  $menu["admin/eck/{$entity_name}/{$entity_type}"] = array(
    'title' => $entity_label,
    'description' => "View all {$entity_label} instances of {$entity_type_label} type",
    'page callback' => "eck__entity_instance__overview",
    'page arguments' => array($entity, $type),
    'access arguments' => array("administer {$entity_label} {$entity_type_label}"),
    'weight' => 0
  );
  
  $menu["admin/eck/{$entity_name}/{$entity_type}/overview"] = array(
    'title' => "Overview",
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0
  );
  
  //CREATE Entity Instance
  $menu["admin/eck/{$entity_name}/{$entity_type}/add"] = array(
    'title' => "Add {$entity_type_label} Instance",
    'description' => "Add {$entity_type_label} Instance",
    'page callback' => "eck__entity_instance__add",
    'page arguments' => array($entity, $type),
    'access arguments' => array("add {$entity_label} instance"),
    'type' => MENU_LOCAL_ACTION,
    'weight' => 1
  );
  
  //READ Entity Instance
  $menu["{$entity_name}/{$entity_type}/%"] = array(
    'title' => "{$entity_name}",
    'description' => "View {$entity_name} objects of type {$entity_type}",
    'page callback' => "eck__entity_instance__page",
    'page arguments' => array($entity, $type, 2),
    'access arguments' => array("view {$entity_name} {$entity_type}"),
    'weight' => 0
  );
  
  //UPDATE Entity Instance
  $menu["{$entity_name}/{$entity_type}/%/edit"] = array(
    'title' => "Edit",
    'description' => "Edit {$entity_name} of type {$entity_type}",
    'page callback' => "eck__entity_instance__edit",
    'page arguments' => array($entity, $type, 2),
    'access arguments' => array("edit {$entity_name} {$entity_type}"),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1
  );
  
  return $menu;
}

function eck__entity_instance__overview($entity, $type) {
  
  $entity_name = $entity->name;
  $entity_label = $entity->label;
  $entity_type = $type->type;
  $entity_type_label = $type->label;
  
  $header = array(t('Name'), array('data' => t('Operations'), 'colspan' => '1'));
  $rows = array();
  
  $table = "eck_{$entity_name}";
  
  //Get all entity instances of this type
  $results = db_select($table, 't')->fields('t')->condition('type', $entity_type, '=')->execute();
  
  foreach ($results as $record) {
      $id = $record->id;
      $objs = entity_load($entity_name, array($id));
      $obj = $objs[$id];
      $uri = entity_uri($entity_name, $obj);
      $row = array(l(entity_label($entity_name, $obj), $uri['path'], $uri['options']));
      $row[] = array('data' => l(t('delete'), "admin/eck/{$entity_name}/$entity_type/{$id}/delete"));
      $rows[] = $row;
  }
  
  $build['entity_table'] = array(
  '#theme' => 'table',
  '#header' => $header,
  '#rows' => $rows,
  );
  
  return $build;
}

function eck__entity_instance__add($entity, $type) {
  
  $entity_name = $entity->name;
  $entity_label = $entity->label;
  $entity_type = $type->type;
  $entity_type_label = $type->label;
  
  global $user;
  
  $values = array();
  $values['entity_name'] = $entity_name;
  $values['type'] = $entity_type;
  $values['uid'] = $user->uid;
  $values['created'] = time();
  $values['changed'] = time();
  
  
  $obj = entity_create($entity_name, $values);
  
  return drupal_get_form("eck__entity_instance__form", $obj);
  
}


function eck__entity_instance__view($entity, $id) {
  
  $entity_name = $entity->name;
  
  if (is_numeric($id)) {
     $obj = entity_load($entity_name, array($id));
  }
  
  return $obj[$id]->view();
}


function eck__entity_instance__edit($entity, $type, $id) {
  $entity_name = $entity->name;
  
  if (is_numeric($id)) {
     $objs = entity_load($entity_name, array($id));
     $obj = $objs[$id];
  }
  
  global $user;
  
  $obj->uid = $user->uid;
  $obj->changed = time(); 
  
  return drupal_get_form("eck__entity_instance__form", $obj);
  
}

/*function eck__entity_delete($form, &$form_state, $name, $label, $id) {

  $objs = entity_load($name, array($id));
  
  
  $form['entity'] =
  array(
    '#type' => 'value',
    '#value' => $objs[$id],
  );
  
  $message = t("are you sure that you want to delete %label : %id", 
    array("%label" => $label, "%id" => $id));
    
  $caption = t("This action is irreversible");
  
  return confirm_form($form, $message, "admin/eck/{$name}", $caption, t('Delete'));
}

function eck__entity_delete_submit($form, &$form_state) {
  $entity = $form_state['values']['entity'];
  
  $entity->delete();
  
  drupal_cron_run();
  
  //Ok, lets delete the entity
  $form_state['redirect'] = "admin/eck/{$entity->entityType()}";
  
}*/

function eck__entity_instance__form($form, $form_state, $entity) {

 $form['entity'] = array(
    '#type' => 'value',
    '#value' => $entity
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#weight' => 10000,
    '#value' => t('Save'),
  );
  
 field_attach_form($entity->entityType(), $entity, $form, $form_state);
  
  return $form;
}

function eck__entity_instance__form_submit($form, &$form_state) {
  $entity = $form_state['values']['entity'];
  
  if(isset($form_state['field'])){
    foreach (array_keys($form_state['field']) as $field) {
      $entity->{$field} = _field_unset_empty($field, $form_state['values'][$field]);
    }
  }
  
  $entity->save();
  
  dpm($entity);
  
  drupal_set_message(t("Entity {$entity->id} has been saved"));
}

function eck__entity_instance__label($entity) {
  $hook_name = "entity_{$entity->entityType()}_label";
 
  $new_label = module_invoke_all($hook_name, $entity, $entity->id);

  if (!empty($new_label)) {
    return $new_label[0];
  }
  else {
    return $entity->id;
  }
}

function eck__entity_instance__uri($entity) {
  return array('path' => "{$entity->entityType()}/{$entity->type}/{$entity->identifier()}");
}

function eck__entity_instance__page($entity, $type, $id) {
  
  $entity_name = $entity->name;
  $entity_label = $entity->label;
  $entity_type = $type->type;
  $entity_type_label = $type->label;
  
  $build = array();
  
  $entity_view = eck__entity_instance__view($entity, $id);
  
  $build["{$entity_name}_{$entity_type}_page"] = $entity_view; 
  
  return $build;
}


/**
 * Define paths for administration of entities
 * 
 * @param $name
 * @param $label
 */
/*function eck__entity_instance_menu($entity_name, $type) {
  $items = array();
  
  //DELETE Entity
  $items["admin/eck/{$name}/delete"] = array(
    'title' => 'Add',
    'description' => "Add {$name}",
    'page callback' => "drupal_get_form",
    'page arguments' => array('eck_delete', $name, $label),
    'access arguments' => array("administer entity"),
   'type' => MENU_CALLBACK,
  );
    

  
  
  
  $items["{$name}/%/view"] = array(
    'title' => "View",
    'type' => MENU_DEFAULT_LOCAL_TASK
  );
  
  //DELETE Entity Instance
  $items["admin/eck/{$name}/%/delete"] = array(
    'title' => "Delete {$name}",
    'description' => "Delete the object of {$name} type",
    'page callback' => "drupal_get_form",
    'page arguments' => array('eck__entity_delete', $name, $label, 3),
    'access arguments' => array("administer entity")
  );
 
  return $items;
}*/

function _get_types($name){
  return db_select("eck_types", 't')->fields('t')->condition('entity', $name)->execute();
  
}

/**
 * Get all the data from a table
 * @param $table the name of the table
 */
function _db_get_all($table) {
 
  $results = db_select($table, 't')->fields('t')->execute();
    
  return $results;
}

/**
 * When an entity form is submitted, field for which no information  was inputed are 
 * still returned, then if we submit that data, empty rows are created in those field databases
 * cluttering them. This function checks and makes sure that the data returned for a field is not
 * empty and unsets it if it is, so no empty data will be added to the database
 * 
 * @param $field_name the name of the field
 * @param $data the data for the field: It usually has this format 
 * array(lang => array( 0 => array( <field stuff> ), 1 => ...));
 */
function _field_unset_empty($field_name, $data) {
 
  //if there is a value we need to check that it is not empty
  $info = field_info_field($field_name);
  
  foreach ($data[LANGUAGE_NONE] as $key => $values) { 
    
    $empty = TRUE;
    foreach (array_keys($info['columns']) as $index) { 
      
      if (!empty($values[$index])) {
        $empty = FALSE;
      }
    }
    if ($empty) {
      unset($data[LANGUAGE_NONE][$key]);
    }
  }
 
  return $data;
}

function _eck_fake_exists(){
  return FALSE;
}


